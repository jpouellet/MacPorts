# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 132263 2015-01-28 16:19:55Z jmr@macports.org $

PortSystem          1.0
PortGroup           qmake 1.0

name                openscad
version             2014.03
revision            3
license             GPL-2
categories          cad
maintainers         nomaintainer
description         Solid 3D CAD modeler for programmers
long_description    OpenSCAD provides constructive solid geometry modeling via \
                    compilation of a text-based representation. Models are composed \
                    with constructive solid geometry techniques and extrusion of \
                    2D outlines. Supports STL, OFF, and DXF files.
platforms           darwin
homepage            http://www.openscad.org/

master_sites        http://files.openscad.org/
distfiles           ${distname}.src${extract.suffix}

checksums           rmd160  ea55d3d5e467e528654d5e98f5f149e10181a371 \
                    sha256  865fdc637a3ceb0678d35e88995411d8e70e8a7937625d7ede147a1570a561c3

depends_build-append \
                    port:bison \
                    port:flex

depends_lib-append  port:boost \
                    port:cgal \
                    port:glew \
                    path:lib/pkgconfig/glib-2.0.pc:glib2 \
                    port:gmp \
                    port:mpfr \
                    port:OpenCSG

configure.env-append \
                    OPENSCAD_LIBRARIES=${prefix}
configure.pre_args-append \
                    VERSION=${version} CONFIG-=debug openscad.pro

use_parallel_build  yes

post-destroot {
    # The install location is wrong so we have to move the files to the expected places

    # Application
    move ${destroot}${prefix}/bin/OpenSCAD.app ${destroot}${applications_dir}

    # Examples
    file mkdir ${destroot}${applications_dir}/OpenSCAD.app/Contents/Resources/examples
    eval xinstall -m 644 [glob ${destroot}${prefix}/share/openscad/examples/*] ${destroot}${applications_dir}/OpenSCAD.app/Contents/Resources/examples
    eval file delete [glob ${destroot}${prefix}/share/openscad/examples/*]

    # Library bitmaps
    file mkdir ${destroot}${applications_dir}/OpenSCAD.app/Contents/Resources/libraries/MCAD/bitmap
    eval xinstall -m 644 [glob ${destroot}${prefix}/share/openscad/libraries/MCAD/bitmap/*] ${destroot}${applications_dir}/OpenSCAD.app/Contents/Resources/libraries/MCAD/bitmap
    eval file delete [glob ${destroot}${prefix}/share/openscad/libraries/MCAD/bitmap/*]
    file delete ${destroot}${prefix}/share/openscad/libraries/MCAD/bitmap

    # Empty directories
    file delete ${destroot}${prefix}/share/openscad/libraries/MCAD/SolidPython
    file delete ${destroot}${prefix}/share/openscad/libraries/MCAD/ThingDoc

    # Libraries
    eval xinstall -m 644 [glob ${destroot}${prefix}/share/openscad/libraries/MCAD/*] ${destroot}${applications_dir}/OpenSCAD.app/Contents/Resources/libraries/MCAD
    eval file delete [glob ${destroot}${prefix}/share/openscad/libraries/MCAD/*]

    # Delete un-needed files
    file delete ${destroot}${prefix}/share/applications/openscad.desktop
    file delete ${destroot}${prefix}/share/pixmaps/openscad.png
}

livecheck.type      regex
livecheck.url       [lindex ${master_sites} 0]
livecheck.regex     ${name}-(\[-0-9.\]+).src${extract.suffix}
